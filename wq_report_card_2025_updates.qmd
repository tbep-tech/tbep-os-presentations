---
title: "2025 PROVISIONAL WATER QUALITY REPORT CARD"
author: 
   - name: Dr. Marcus Beck, <mbeck@tbep.org>
institute: "Tampa Bay Estuary Program"
date: "2025-12-09"
date-format: medium
format:
  revealjs:
    logo: figure/TBEP_logo.png
    transition: slide
    footer: "Tampa Bay Nitrogen Management Consortium"
    theme: styles.scss
    link-external-icon: true
    linkcolor: "#00806E"
    link-external-newwindow: true
lightbox: true

execute:
  echo: false
  ft.keepnext: false
---

```{r}
#| include: false
library(knitr)
library(tbeptools)
library(patchwork)
library(flextable)
library(tidyverse)
library(plotly)
library(sf)
library(leaflet)
library(here)
library(readxl)

source('R/funcs.R')

maxyr <- 2025
partialyr <- T

epcdata <- read_importwq('data/currentdata.xlsx', download_latest = F)
vols <- rdataload('https://github.com/tbep-tech/sso-reporting/raw/refs/heads/main/data/vols.RData')
load(file = here::here('data/sgsegest.RData'))

# segment coverage targets in 1k acres
segtrgs <- tibble(
  segment = factor(
    c(levels(sgsegest$segment), 'Total'), 
    levels = c(levels(sgsegest$segment), 'Total')
    ), 
  trgs = c(11.1, 1.751, 9.4, 7.4, 8.8, 1.1, 0.449, 40)
)  

# worst case coverage ests in 1k acres, 1982
segworst <- tibble(
  segment = factor(
    c(levels(sgsegest$segment), 'Total'), 
    levels = c(levels(sgsegest$segment), 'Total')
    ), 
  trgs = c(5.94, 0, 4.04, 5.02, 5.77, 0.75, 0.13, 21.65)
) 
```

------------------------------------------------------------------------

## RA FRAMEWORK

::: columns
::: {.column width="50%"}
-   Each year, assess attainment of water quality thresholds
-   Annual reporting to FDEP, fourth year of [2022-2026 RA period](https://drive.google.com/file/d/18HHMx4U6vHNrFyepEFuoTJ_sEKyTA_gu/view)
-   Today's results include data __through September__
:::

::: {.column width="50%"}
![](figure/decisionframework.png){width="450" fig-align="center"}
:::
:::

------------------------------------------------------------------------

## CHLOROPHYLL TRENDS

```{r}
#| fig-height: 6
yrrng <- c(1975, maxyr)
txtcol <- 'black'
thrthm <- theme(
    plot.background = element_rect(fill = NA, color = NA),
    axis.text.y = element_text(colour = txtcol, size = 12),
    axis.title.x = element_blank(),
    plot.title = element_text(size = 15, colour = txtcol),
    legend.text = element_text(size = 12, colour = txtcol),
    axis.text.x = element_text(colour = txtcol, angle = 0, size = 12, hjust = 0.5),
    legend.position = 'bottom'
  )
sclx <- scale_x_continuous(breaks = seq(1975, maxyr, by = 5))

p1 <- show_thrplot(epcdata, bay_segment = "OTB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + labs(caption = NULL)
p2 <- show_thrplot(epcdata, bay_segment = "HB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + labs(caption = NULL)
p3 <- show_thrplot(epcdata, bay_segment = "MTB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + labs(caption = NULL)
p4 <- show_thrplot(epcdata, bay_segment = "LTB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx

p1 + p2 + p3 + p4 + plot_layout(guides = 'collect', axis_titles = 'collect_y') & thrthm
```

------------------------------------------------------------------------

## SEASONAL CHLOROPHYLL

```{r}
#| fig-height: 6
yrrng <- c(1975, maxyr)
txtcol <- 'black'
thrthm <- theme(
    plot.background = element_rect(fill = NA, color = NA),
    axis.text.y = element_text(colour = txtcol, size = 12),
    axis.title.x = element_blank(),
    plot.title = element_text(size = 15, colour = txtcol),
    legend.text = element_text(size = 12, colour = txtcol),
    axis.text.x = element_text(size = 10, colour = txtcol, angle = 0, hjust = 0.5),
    legend.position = 'bottom'
  )

outliers <- F

p1 <- show_boxplot(epcdata, bay_segment = "OTB", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr, points = outliers) + labs(caption = NULL)
p2 <- show_boxplot(epcdata, bay_segment = "HB", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr, points = outliers) + labs(caption = NULL)
p3 <- show_boxplot(epcdata, bay_segment = "MTB", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr, points = outliers) + labs(caption = NULL)
p4 <- show_boxplot(epcdata, bay_segment = "LTB",  yrrng = yrrng, yrsel = maxyr, partialyr = partialyr, points = outliers)

p1 + p2 + p3 + p4 + plot_layout(guides = 'collect', axis_titles = 'collect_y') & thrthm
```

------------------------------------------------------------------------

## CHLOROPHYLL BY SITE

```{r}
show_sitesegmap(epcdata, yrsel = maxyr, param = "chla", partialyr = T, thrs = T)
```

------------------------------------------------------------------------

## LIGHT ATTENUATION TRENDS

```{r}
#| fig-height: 6
yrrng <- c(1975, maxyr)
txtcol <- 'black'
thrthm <- theme(
    plot.background = element_rect(fill = NA, color = NA),
    axis.text.y = element_text(colour = txtcol, size = 12),
    axis.title.x = element_blank(),
    plot.title = element_text(size = 15, colour = txtcol),
    legend.text = element_text(size = 12, colour = txtcol),
    axis.text.x = element_text(colour = txtcol, angle = 0, size = 12, hjust = 0.5),
    legend.position = 'bottom'
  )
sclx <- scale_x_continuous(breaks = seq(1975, maxyr, by = 5))

p1 <- show_thrplot(epcdata, bay_segment = "OTB", thr = "la", yrrng = yrrng, partialyr = partialyr) + sclx + labs(caption = NULL)
p2 <- show_thrplot(epcdata, bay_segment = "HB", thr = "la", yrrng = yrrng, partialyr = partialyr) + sclx + labs(caption = NULL)
p3 <- show_thrplot(epcdata, bay_segment = "MTB", thr = "la", yrrng = yrrng, partialyr = partialyr) + sclx + labs(caption = NULL)
p4 <- show_thrplot(epcdata, bay_segment = "LTB", thr = "la", yrrng = yrrng, partialyr = partialyr) + sclx

p1 + p2 + p3 + p4 + plot_layout(guides = 'collect', axis_titles = 'collect_y') & thrthm
```

------------------------------------------------------------------------

## SEASONAL LIGHT ATTENUATION

```{r}
#| fig-height: 6
yrrng <- c(1975, maxyr)
txtcol <- 'black'
thrthm <- theme(
    plot.background = element_rect(fill = NA, color = NA),
    axis.text.y = element_text(colour = txtcol, size = 12),
    axis.title.x = element_blank(),
    plot.title = element_text(size = 15, colour = txtcol),
    legend.text = element_text(size = 12, colour = txtcol),
    axis.text.x = element_text(size = 10, colour = txtcol, angle = 0, hjust = 0.5),
    legend.position = 'bottom'
  )

outliers <- F

p1 <- show_boxplot(epcdata, bay_segment = "OTB", param = "la", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr, points = outliers) + labs(caption = NULL)
p2 <- show_boxplot(epcdata, bay_segment = "HB", param = "la", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr, points = outliers) + labs(caption = NULL)
p3 <- show_boxplot(epcdata, bay_segment = "MTB", param = "la", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr, points = outliers) + labs(caption = NULL)
p4 <- show_boxplot(epcdata, bay_segment = "LTB",  param = "la", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr, points = outliers)

p1 + p2 + p3 + p4 + plot_layout(guides = 'collect', axis_titles = 'collect_y') & thrthm
```

------------------------------------------------------------------------

## LIGHT ATTENUATION BY SITE

```{r}
show_sitesegmap(epcdata, yrsel = maxyr, param = "la", partialyr = T, thrs = T)
```

------------------------------------------------------------------------

## WATER QUALITY REPORT CARD

<https://tbep-tech.github.io/wq-static/wq.pdf>

::::: {.columns style='display: flex !important; height: 80%;'}

::: {.column width="50%" style="display: flex; justify-content: center; align-items: center;"}
![Management](figure/wq2025prov1.png){width="360"}
:::

::: {.column width="50%" style="display: flex; justify-content: center; align-items: center;"}
![Regulatory](figure/wq2025prov2.png){width="360"}
:::

:::::

------------------------------------------------------------------------

## REGULATORY THRESHOLDS

* Each bay segment evaluated by chlorophyll-a threshold

![](figure/regthresh.png)

------------------------------------------------------------------------

## REGULATORY OUTCOMES

```{r}
#| layout-ncol: 2
#| fig-height: 5
#| out-height: 100%
show_wqmatrix(epcdata, txtsz = NULL, yrrng = c(1975, 1998), partialyr = T, plotly = T, height = 450, width = 450)
show_wqmatrix(epcdata, txtsz = NULL, yrrng = c(1999, maxyr), partialyr = T, plotly = T, height = 450, width = 450)
```

\* `r maxyr` Dec based on average from five years prior

------------------------------------------------------------------------

## MANAGEMENT ACTIONS

* Each bay segment assigned a management action, based on chlorophyll and light attenuation magnitude and duration

![](figure/wqactions.jpg)

------------------------------------------------------------------------

## MANAGEMENT OUTCOMES

```{r}
#| layout-ncol: 2
#| fig-height: 5
#| out-height: 100%
show_matrix(epcdata, txtsz = NULL, yrrng = c(1975, 1998), partialyr = T, plotly = T, height = 450, width = 450)
show_matrix(epcdata, txtsz = NULL, yrrng = c(1999, maxyr), partialyr = T, plotly = T, height = 450, width = 450)
```

\* `r maxyr` Dec based on average from five years prior

------------------------------------------------------------------------

## CHLOROPHYLL ATTAINMENT

```{r}
show_sitesegmap(epcdata, yrsel = maxyr, param = 'chla', partialyr = T, thrs = F)
```

------------------------------------------------------------------------

## LIGHT ATTENUATION ATTAINMENT

```{r}
show_sitesegmap(epcdata, yrsel = maxyr, param = 'la', partialyr = T, thrs = F)
```

## PYRODINIUM STATUS

```{r}
yrmin <- 2014
bridges <- tibble(
    brdg = c('Gandy', 'HF', 'CC'),
    Latitude = c(27.880486, 27.922358652608654, 27.965458)
  ) |> 
  crossing(
    yr = seq(yrmin, maxyr)
  )

# https://f50006a.eos-intl.net/F50006A/OPAC/Details/Record.aspx?BibCode=5635517
datall <- read.csv('https://f50006a.eos-intl.net/ELIBSQL12_F50006A_Documents/OTBMP_Pyrodinium_Chl_2011-2020_v101922.csv') %>%
  select(
    yr = Year,
    date = Sample_Date,
    Latitude,
    Longitude,
    pyro = P..bahamense.Abundance..cells.L.
  ) %>%
  mutate(date = mdy(date))

# 2021 only
dat2021 <- read.csv(here('data/Pyrodinium_Chl_2021_OTBMP_mbeck.csv')) %>%
  select(
    date = Sample_Date,
    Latitude,
    Longitude,
    pyro = Pbahamense..cells.L.
  ) %>%
  mutate(
    date = case_when(
      grepl('[a-z]', date) ~ dmy(date),
      T ~ mdy(date)
    )
  )

# 2022 only
dat2022 <- read.csv(here('data/Pyrodinium_Chla_OTBMP_2022.csv')) %>%
  select(
    date = Date,
    Latitude,
    Longitude,
    pyro = Pyrodinium..Cells.L.
  ) %>%
  mutate(date = mdy(date))

# 2023 only
dat2023 <- read_excel(here('data/2023 OTB Pyrodinium bahamense abundance data.xlsx')) %>% 
  select(
    date = `Sample Date`,
    Latitude,
    Longitude,
    pyro = `Pyrodinium bahamense abundance (cells/L)`
  ) %>%
  mutate(date = ymd(date))

# 2024, 2025
dat2425 <- read_excel(here('data/TB Pyro 2024-2025.12.03.xlsx')) |> 
  select(
    date = `Sample Date`,
    Latitude,
    Longitude,
    pyro = `Pyrodinium bahamesnse abundance (cells/L*)`
  ) %>%
  mutate(date = ymd(date))

brks <- c(-Inf, 1e4, 1e5, 1e6, Inf)
labs <- c('No bloom', 'Low', 'Medium', 'High')

dat <- bind_rows(datall, dat2021, dat2022, dat2023, dat2425) %>%
  mutate(
    yr = year(date),
    doy = yday(date),
    pyro = ifelse(pyro == 0, NA, pyro),
    pyrocat = cut(pyro, breaks = brks, labels = labs),
    pyro = pmin(3e6, pyro)
  )

toplo <- dat %>% 
  filter(yr >= yrmin)

# doy x-axis breaks and labels
dts <- seq.Date(as.Date('2023-01-01'), as.Date('2023-10-01'), by = "3 month")
xbrks <- yday(dts)                       
xlabs <- format(dts, "%b")

ggplot(subset(toplo, !is.na(pyro)), aes(x = doy, y = Latitude)) +
  geom_hline(data = bridges, aes(yintercept = Latitude), linetype = 'solid') +
  geom_point(data = subset(toplo, is.na(pyro)), aes(shape = "No cells"),
             size = 1, color = "lightgrey") +
  geom_point(aes(fill = pyrocat, size = pyro), shape = 21, color = 'black') +
  scale_x_continuous(limits = c(0, 365), breaks = xbrks, labels = xlabs) +
  scale_fill_viridis_d(guide = "legend", option = 'A', direction = -1, na.value = 'lightgrey') +
  scale_size_continuous(range = c(1, 5), breaks = c(1e6, 2e6, 3e6), labels = c('1e6', '2e6', '> 3e6')) +
  facet_wrap(~yr, ncol = 4) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    panel.grid = element_blank(),
    legend.spacing.y = unit(-0.2, "cm")
  ) +
  guides(fill = guide_legend(override.aes = list(size = 3), order = 2),
         size = guide_legend(order = 3),
         shape = guide_legend(order = 1)) +
  labs(
    x = 'Day of Year',
    shape = NULL,
    fill = 'Bloom intensity\n',
    size = 'Cells/L\n',
    subtitle = expression(paste(italic('P. bahamense'), ' cell counts by location and date in Old Tampa Bay')),
    caption = 'Data from FWC-FWRI HAB Monitoring Database, dotted lines are bridge locations'
  )

```


------------------------------------------------------------------------

## EVALUATING SSOs

* FDEP maintains [Public Notice of Pollution](https://prodenv.dep.state.fl.us/DepPNP/reports/viewIncidentDetails?page=1) database
* Reports indicate location, date, contact, and narrative description
* Details in narrative description...

------------------------------------------------------------------------

## EVALUATING SSOs

* An example of a spill volume description:

```{r}
vols$descrip[1]
```

------------------------------------------------------------------------

## SSOs 2017 to present

```{r}
toplo <- vols |>
  group_by(yr, bay_segment) |>
  summarise(volest = sum(volest), .groups = 'drop') |>
  mutate(
    volest = volest / 1e6,
    bay_segment = factor(bay_segment, levels = c('OTB', 'HB', 'MTB', 'LTB', 'BCB', 'MR', 'TCB'))
  )
tots <- nrow(vols)
toplo_wide <- toplo |>
  pivot_wider(
    names_from = bay_segment,
    values_from = volest,
    values_fill = 0,
    names_expand = T
  )

plot_ly() |>
  add_bars(data = toplo_wide, x = ~yr, y = ~`OTB`, name = "Old Tampa Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~yr, y = ~`HB`, name = "Hillsborough Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~yr, y = ~`MTB`, name = "Middle Tampa Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~yr, y = ~`LTB`, name = "Lower Tampa Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~yr, y = ~`BCB`, name = "Boca Ciega Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~yr, y = ~`MR`, name = "Manatee River",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~yr, y = ~`TCB`, name = "Terra Ceia Bay",
           opacity = 0.7) |>
  layout(
    barmode = "stack",
    showlegend = TRUE,
    legend = list(
      orientation = "h",
      y = 1.15,
      x = 0.5,
      xanchor = "center",
      traceorder = "reversed"
    ),
    xaxis = list(
      title = "",
      showgrid = FALSE,
      zeroline = FALSE
    ),
    yaxis = list(
      title = "Million gallons reported",
      showgrid = TRUE,
      gridcolor = "lightgray",
      zeroline = FALSE
    ),
    font = list(
      size = 14
    ),
    annotations = list(
      x = 1,
      y = -0.09,
      text = paste0("Total n = ", tots),
      showarrow = FALSE,
      xref = 'paper',
      yref = 'paper',
      font = list(size = 12)
    ),
    autosize = F,
    width = 1000,
    height = 450
  ) |>
  config(displayModeBar = F)
```

* 2016 baseline ~200M gallons

------------------------------------------------------------------------

## SSOs 2025 by month

```{r}
toplo <- vols |>
  filter(yr == maxyr) |>
  group_by(modt, bay_segment) |>
  summarise(volest = sum(volest), .groups = 'drop') |>
  mutate(
    volest = volest / 1e6,
    bay_segment = factor(bay_segment, levels = c('OTB', 'HB', 'MTB', 'LTB', 'BCB', 'MR', 'TCB'))
  )
tots <- sum(vols$yr == maxyr)
toplo_wide <- toplo |>
  pivot_wider(
    names_from = bay_segment,
    values_from = volest,
    values_fill = 0,
    names_expand = T
  )

plot_ly() |>
  add_bars(data = toplo_wide, x = ~modt, y = ~`OTB`, name = "Old Tampa Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~modt, y = ~`HB`, name = "Hillsborough Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~modt, y = ~`MTB`, name = "Middle Tampa Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~modt, y = ~`LTB`, name = "Lower Tampa Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~modt, y = ~`BCB`, name = "Boca Ciega Bay",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~modt, y = ~`MR`, name = "Manatee River",
           opacity = 0.7) |>
  add_bars(data = toplo_wide, x = ~modt, y = ~`TCB`, name = "Terra Ceia Bay",
           opacity = 0.7) |>
  layout(
    barmode = "stack",
    showlegend = TRUE,
    legend = list(
      orientation = "h",
      y = 1.15,
      x = 0.5,
      xanchor = "center",
      traceorder = "reversed"
    ),
    xaxis = list(
      title = "",
      showgrid = FALSE,
      zeroline = FALSE
    ),
    yaxis = list(
      title = "Million gallons reported",
      showgrid = TRUE,
      gridcolor = "lightgray",
      zeroline = FALSE
    ),
    font = list(
      size = 14
    ),
    annotations = list(
      x = 1,
      y = -0.09,
      text = paste0("Total n = ", tots),
      showarrow = FALSE,
      xref = 'paper',
      yref = 'paper',
      font = list(size = 12)
    ),
    autosize = F,
    width = 1000,
    height = 450
  ) |>
  config(displayModeBar = F)
```

------------------------------------------------------------------------

## 2024 SEAGRASS COVERAGE

```{r}
show_seagrasscoverage(seagrass, lastlab = T)
```

------------------------------------------------------------------------

## 2024 SEAGRASS RESULTS: SEGMENT

* Continued loss in OTB, gain in HB

```{r}
#| fig-align: "center"
#| fig-height: 4.5
#| fig-width: 9
toplo <- sgsegest %>%
  filter(segment %in% c('Old Tampa Bay', 'Hillsborough Bay', 'Middle Tampa Bay', 'Lower Tampa Bay')) %>%
  mutate(acres = acres / 1000) %>%
  mutate(segment = forcats::fct_drop(segment))

subsegtrgs <- segtrgs %>%
  filter(segment %in% levels(toplo$segment))

arrdf <- tibble(
  segment = factor('Old Tampa Bay', levels = levels(toplo$segment)),
  x = factor(2024),
  xend = factor(2024),
  y = 8,
  yend =  5
)

ggplot(toplo, aes(x = factor(year), y = acres)) +
  geom_bar(fill = '#00806E', stat = 'identity', colour = 'black', width = 0.6) +
  geom_hline(data = subsegtrgs, aes(yintercept = trgs, color = 'Target')) +
  geom_segment(
    data = arrdf,
    aes(x = x, xend = xend, y = y, yend = yend),
    arrow = arrow(length = grid::unit(0.5, "cm")),
    size = 2, lineend = 'round', linejoin = 'round', col = 'red'
  ) +
  scale_color_manual(values = 'red') +
  facet_wrap(~segment, ncol = 2, scales = 'free') +
  theme(panel.grid.minor=element_blank(),
        panel.grid.major=element_blank(),
        plot.background = element_rect(fill = NA, color = NA),
        axis.text.y = element_text(colour = 'black'),
        plot.title = element_text(size = 22, colour = 'black'),
        legend.text = element_text(size = 16, colour = 'black'),
        axis.text.x = element_text(colour = 'black', angle = 45, size = 8, hjust = 1),
        strip.background = element_blank(),
        strip.text = element_text(hjust = 0, size = 13),
        legend.position = 'none'
  ) +
  labs(
    y = 'Seagrass Coverage (x1,000 acres)',
    x = NULL,
    color = NULL
  )
```

------------------------------------------------------------------------

## 2024 SEAGRASS RESULTS: SEGMENT

* Remainder bay segments relatively stable

```{r}
#| fig-align: "center"
#| fig-height: 4.25
#| fig-width: 9
toplo <- sgsegest %>%
  filter(segment %in% c('Boca Ciega Bay', 'Terra Ceia Bay', 'Manatee River')) %>%
  mutate(acres = acres / 1000) %>%
  mutate(segment = forcats::fct_drop(segment))

subsegtrgs <- segtrgs %>%
  filter(segment %in% levels(toplo$segment))

ggplot(toplo, aes(x = factor(year), y = acres)) +
  geom_bar(fill = '#00806E', stat = 'identity', colour = 'black', width = 0.6) +
  geom_hline(data = subsegtrgs, aes(yintercept = trgs, color = 'Target')) +
  scale_color_manual(values = 'red') +
  facet_wrap(~segment, ncol = 2, scales = 'free') +
  theme(panel.grid.minor=element_blank(),
        panel.grid.major=element_blank(),
        plot.background = element_rect(fill = NA, color = NA),
        axis.text.y = element_text(colour = 'black'),
        plot.title = element_text(size = 22, colour = 'black'),
        legend.text = element_text(size = 16, colour = 'black'),
        axis.text.x = element_text(colour = 'black', angle = 45, size = 8, hjust = 1),
        strip.background = element_blank(),
        strip.text = element_text(hjust = 0, size = 13),
        legend.position = 'none'
  ) +
  labs(
    y = 'Seagrass Coverage (x1,000 acres)',
    x = NULL,
    color = NULL
  )
```

------------------------------------------------------------------------

## TARGET ATTAINMENT vs WORST CASE

```{r}
#| fig-align: "center"
#| fig-width: 9
#| fig-height: 5
levs <- c(levels(sgsegest$segment), 'Total')

totest <- seagrass %>%
  select(-Hectares) %>%
  mutate(segment = 'Total') %>%
  rename(
    year = Year,
    acres = Acres
    ) %>%
  filter(year == 2024)

toplo <- sgsegest %>%
  filter(year == 2024) %>%
  bind_rows(totest) %>%
  mutate(acres = acres / 1000) %>%
  pivot_wider(names_from = 'year', values_from = 'acres') %>%
  bind_rows %>%
  left_join(segworst, by = 'segment') %>%
  rename(`1982` = trgs) %>%
  left_join(segtrgs, by = 'segment') %>%
  pivot_longer(cols = c(`2024`, `1982`), names_to = 'Year', values_to = 'Acres') %>%
  mutate(
    attain = Acres / trgs,
    segment = factor(segment, levels = levels(segtrgs$segment)),
    Year = factor(Year, levels = c(1982, 2024), labels = c('1982 - Worst Case', '2024'))
  )

ggplot(toplo, aes(x = segment, y = attain)) +
  coord_cartesian(ylim = c(0, 1.3)) +
  scale_y_continuous(expand = c(0, 0), labels = scales::percent, breaks = c(0, .25, 0.5, 0.75, 1)) +
  geom_text(aes(group = Year, label = scales::percent(round(attain, 2))), position = position_dodge(width = 0.9), vjust = -0.5, size = 3) +
  geom_text(data = segtrgs, aes(y = 1.2, label = paste(formatC(1000 * trgs, format = 'd', big.mark = ','), '\nacres'))) +
  geom_col(position = 'dodge', aes(group = Year, fill = Year), color = 'black') +
  scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = 10)) +
  scale_fill_manual(values = c('grey', '#00806E')) +
  geom_vline(xintercept = 7.5, linetype = 'dashed') +
  geom_segment(aes(x = 0.75, xend = 1.25, y = 0.7, yend = 0.54), arrow = arrow(length = unit(0.5, "cm")), size = 2, lineend = 'round', linejoin = 'round', col = 'red') +
  geom_text(aes(x = 1.5, y = 0.65, label = '2024 OTB is now\nworst case'), size = 3, col = 'red') +
  theme_minimal() +
  theme(
    legend.position = 'bottom',
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.minor.y = element_blank()
  ) +
  labs(
    y = '% Attainment of Target Acreage',
    fill = NULL,
    x = NULL
  )
```

------------------------------------------------------------------------

## 2025 SEAGRASS TRANSECTS

```{r}
transectocc <- anlz_transectocc(transect)
toplo <- anlz_transectavespp(transectocc, total = T, bay_segment = c('OTB', 'HB', 'MTB', 'LTB'), yrrng = c(1998, maxyr), species = c('Halodule', 'Syringodium', 'Thalassia'), by_seg = T) %>%
  filter(Savspecies == 'total') |>
  arrange(bay_segment, yr) |>
  mutate(
    fochg = foest - lag(foest),
    chgsgn = ifelse(fochg > 0, 'increase', 'decrease')
  ) |>
  na.omit()
ggplot(toplo, aes(x = yr, y = foest)) +
  geom_line() + 
  geom_point(aes(fill = chgsgn), color = 'black', pch = 21, size = 2) +
  geom_point(data = toplo[toplo$yr == maxyr, ], aes(fill = chgsgn), color = 'black', size = 4, pch = 21, stroke = 2) +
  facet_wrap(~bay_segment, ncol = 2) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    x = NULL,
    y = 'Frequency of Occurrence'
  ) +
  scale_fill_manual(values = c('increase' = '#2DC938', 'decrease' = '#CC3231')) +
  theme_minimal() +
  theme(
    legend.position = 'none',
    strip.text = element_text(size = 12),
    strip.background = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor = element_blank()
  )
```

------------------------------------------------------------------------

## 2025 SEAGRASS TRANSECTS BY SITE 

```{r}
#| out-width: 100%
toplo <- transectocc |> 
  ungroup() |> 
  mutate(
    yr = lubridate::year(Date)
  ) |> 
  filter(Savspecies %in% 'total') |> 
  filter(yr >= 2024) |> 
  select(Transect, yr, foest) |> 
  summarise(
    foest = mean(foest, na.rm = T), 
    .by = c(Transect, yr)
  ) |> 
  mutate(
    cnt = n(), 
    .by = Transect
  ) |> 
  filter(cnt == 2) |> 
  select(-cnt) |> 
  pivot_wider(
    names_from = yr, 
    values_from = foest
  ) |> 
  mutate(
    chg = abs(`2025` - `2024`),
    sgn = sign(`2025` - `2024`)
  )
tomap <- inner_join(trnpts, toplo, by = c('TRAN_ID' = 'Transect')) |> 
  select(TRAN_ID, chg, sgn, '2024', '2025')

# make leaflet map with points sized by change and colored by sign
# add bay segment lines from tbseglines
leaflet(tomap) |> 
  addProviderTiles(providers$CartoDB.Positron) |> 
  addPolylines(data = tbseglines, color = 'blue', weight = 2, opacity = 0.5) |>
  addCircleMarkers(
    radius = ~ scales::rescale(chg, to = c(5, 15)),
    color = ~ ifelse(sgn > 0, '#2DC938', '#CC3231'),
    stroke = TRUE,
    weight = 1,
    fillOpacity = 0.8,
    label = ~ lapply(paste0('Transect: ', TRAN_ID, '<br>',
                    '2024 F.O.: ', scales::percent(`2024`, accuracy = 0.1), '<br>',
                    '2025 F.O.: ', scales::percent(`2025`, accuracy = 0.1), '<br>',
                    'Change: ', ifelse(sgn > 0, '+', ''), scales::percent(`2025` - `2024`, accuracy = 0.1)), htmltools::HTML)
  ) |> 
  addLegend(
    position = 'bottomright',
    colors = c('#2DC938', '#CC3231'),
    labels = c('Increase', 'Decrease'),
    title = 'Frequency of Occurrence Change (2024 - 2025)'
  )
```

------------------------------------------------------------------------

## CONCLUSIONS

::: {.incremental}
* All segments provisionally (through September) meet regulatory thresholds, all segments provisionally green for management targets
* Adaptive capacity of the bay is high coming off dry years
* OTB still a marginal bay segment, continued seagrass coverage loss, slight uptick in frequency occurrence in 2025
* Fourth year of [2022 - 2026 RA period](https://docs.google.com/document/d/1e3KpnZFPJNm8TFlpSEfj3fHIa2nc6KfmKsn5LzaEp1g/edit?disco=AAAAaa0p5rc)
:::
